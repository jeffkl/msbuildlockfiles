<Project>
  <PropertyGroup>
    <BuildLockFilePath Condition="'$(BuildLockFilePath)' == ''">$([System.IO.Path]::Combine($(MSBuildProjectDirectory), 'build.lock.yml'))</BuildLockFilePath>
  </PropertyGroup>

  <Target Name="WriteTargetFrameworkLockFileAfterBuild"
          AfterTargets="Build"
          Condition="'$(UsingMicrosoftNETSdk)' == 'true' And '$(TargetFramework)' != ''"
          DependsOnTargets="WriteTargetFrameworkLockFile" />

  <Target Name="LegacyWriteBuildLockFileAfterBuild"
          AfterTargets="Build"
          Condition="'$(UsingMicrosoftNETSdk)' != 'true' And '$(TargetFrameworkVersion)' != ''"
          DependsOnTargets="WriteTargetFrameworkLockFile;WriteBuildLockFile" />

  <Target Name="WriteBuildLockFileAfterBuild"
          AfterTargets="Build"
          DependsOnTargets="WriteBuildLockFile"
          Condition="'$(UsingMicrosoftNETSdk)' == 'true' And '$(GeneratePackageOnBuild)' != 'true' And '$(IsInnerBuild)' != 'true'" />

  <Target Name="WriteBuildLockFileAfterPack"
          AfterTargets="Pack"
          DependsOnTargets="WriteBuildLockFile"
          Condition="'$(UsingMicrosoftNETSdk)' == 'true' And '$(GeneratePackageOnBuild)' == 'true' And '$(IsInnerBuild)' != 'true'" />

  <Target Name="WriteTargetFrameworkLockFile"
          DependsOnTargets="GetTargetFrameworkLockFiles">
    <ItemGroup>
      <_FolderRoots Remove="@(_FolderRoots)" />
      <_FolderRoots Include="#OutputPath" Path="$([MSBuild]::NormalizePath($(OutputPath)))" />
      <_FolderRoots Include="!IntermediateOutputPath" Path="$([MSBuild]::NormalizePath($(IntermediateOutputPath)))" />
      <_FolderRoots Include="MSBuildProjectExtensionsPath" Path="$(MSBuildProjectExtensionsPath)" />
      <_FolderRoots Include="NuGetPackageRoot" Path="$(NuGetPackageRoot)" />
      <_FolderRoots Include="#MSBuildProjectDirectory" Path="$(MSBuildProjectDirectory)\" AllowRelative="true" />
      <_FolderRoots Include="FrameworkAssemblies" Path="$(FrameworkPathOverride)" />
      <_FolderRoots Include="MicrosoftNETBuildExtensions" Path="$([System.IO.Path]::GetDirectoryName($(MicrosoftNETBuildExtensionsTargets)))" />
      <_FolderRoots Include="NetCoreTargetingPackRoot" Path="$(NetCoreTargetingPackRoot)" />
    </ItemGroup>

    <PropertyGroup>
      <_LockFileTargetFramework Condition="'$(TargetFramework)' != ''">$(TargetFramework)</_LockFileTargetFramework>
      <_LockFileTargetFramework Condition="'$(_LockFileTargetFramework)' == '' And '$(_TargetFrameworkVersionWithoutV)' != ''">net$(_TargetFrameworkVersionWithoutV.Replace('.', ''))</_LockFileTargetFramework>
    </PropertyGroup>

    <WriteTargetFrameworkLockFile
      References="@(ReferencePathWithRefAssemblies)"
      FolderRoots="@(_FolderRoots)"
      DefineConstants="$(DefineConstants)"
      Sources="@(Compile);@(EmbeddedResource)"
      TargetFramework="$(_LockFileTargetFramework)"
      FileWrites="@(FileWrites)"
      FilePath="@(TargetFrameworkLockFile)" />
  </Target>

  <Target Name="WriteBuildLockFile"
          DependsOnTargets="GetTargetFrameworkLockFiles">
    <ItemGroup>
      <_FolderRoots Remove="@(_FolderRoots)" />
      <_FolderRoots Include="#PackageOutputPath" Path="$([MSBuild]::NormalizePath($(PackageOutputPath)))" Condition="'$(PackageOutputPath)' != ''" />
    </ItemGroup>

    <ItemGroup>
      <_BuildOutputs Remove="@(_BuildOutputs)" />
    </ItemGroup>

    <ItemGroup Condition="'$(GeneratePackageOnBuild)' == 'true' And '$(ContinuePackingAfterGeneratingNuspec)' != 'false'">
      <_BuildOutputs Include="$(PackageOutputAbsolutePath)$(PackageId).$(PackageVersion).nupkg" />
      <_BuildOutputs Include="$(PackageOutputAbsolutePath)$(PackageId).$(PackageVersion).snupkg"
                     Condition="'$(SymbolPackageFormat)' == 'nupkg' "/>
    </ItemGroup>

    <WriteBuildLockFile LockFiles="@(TargetFrameworkLockFile)"
                        FolderRoots="@(_FolderRoots)"
                        Outputs="@(_BuildOutputs)"
                        FilePath="$(BuildLockFilePath)" />
  </Target>

  <Target Name="GetTargetFrameworkLockFiles"
          DependsOnTargets="GetTargetFrameworkLockFile"
          Returns="@(TargetFrameworkLockFile)">
  </Target>

  <Target Name="GetTargetFrameworkLockFile"
          Returns="@(TargetFrameworkLockFile)">
    <ItemGroup>
      <TargetFrameworkLockFile Include="$([MSBuild]::ValueOrDefault($(TargetFrameworkLockFilePath), '$(IntermediateOutputPath)build.lock.yml'))" />
    </ItemGroup>
  </Target>
</Project>